---
# This workflow integrates Qwiet preZero with GitHub and exports SARIF results to the Security Tab
name: Qwiet

on:
  pull_request:
  workflow_dispatch:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron: '0 11 * * 6'

permissions:
  security-events: write  # Ensure proper permissions to upload SARIF results

jobs:
  NextGen-Static-Analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Java JDK v11
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: 11

      # Run Maven in the xz-java-malicious subdirectory
      - name: Maven build
        working-directory: ./xz-java-malicious
        run: mvn clean install

      - name: Install malicious JAR into local Maven repo
        working-directory: ./xz-java-malicious
        run: |
          mvn install:install-file \
            -Dfile=target/xz-java-1.9.2.jar \
            -DgroupId=org.tukaani \
            -DartifactId=xz \
            -Dversion=1.9.2-malicious \
            -Dpackaging=jar

      - name: Download Qwiet CLI
        run: |
          curl -sSL https://cdn.shiftleft.io/download/sl -o "${GITHUB_WORKSPACE}/sl"
          chmod a+rx "${GITHUB_WORKSPACE}/sl"

      - name: Extract branch name
        id: extract_branch
        shell: bash
        run: |
          # Use head ref for PRs, fall back to branch name for other events
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "branch=${BRANCH_NAME}" >> "$GITHUB_OUTPUT"

      - name: preZero NextGen Static Analysis
        run: |
          "${GITHUB_WORKSPACE}/sl" analyze \
            --strict \
            --app DVSCA \
            --wait \
            --verbose \
            --tag "branch=${{ github.head_ref || steps.extract_branch.outputs.branch }}"
        env:
          SHIFTLEFT_ACCESS_TOKEN: ${{ secrets.SHIFTLEFT_ACCESS_TOKEN }}
